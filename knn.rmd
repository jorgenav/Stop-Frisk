---
title: "Models"
author: "Jorge Navarro Garcia"
date: "13 de abril de 2017"
output: pdf_document
---

```{r, message=FALSE}
# Carga de librer칤as
# Carga de librer眼s
library(magrittr)
library(dplyr)
library(car)
library(effects)
library(randomForest)
library(caret)
library(dataQualityR)
library(DMwR)
library(foreach)
library(class)
library(doMC)
registerDoMC(4)

```

# Creaci칩n de modelos predictivos

Dado que la variable target *arstmade* muestra un desbalanceo en sus clases, 15% clase positiva frente a 85% clase negativa, es necesario tener en cuenta m칠tricas de evaluaci칩n de los modelos que tengan en cuenta las diferencias entre clases a la hora de realizar predicciones. De esta forma, la evaluaci칩n de modelos mediante el coeficiente de *accuracy*, una de las m칠tricas m치s comunes en problemas de clasificaci칩n binaria, se muestra incompleta. Por ello se tiene en cuenta otro tipo de m칠tricas como la matriz de confusi칩n o 

## Carga de datos

```{r,message=FALSE}
# Carga del Dataset
source('E:/apuntes Master/Mineria de datos/Stop-Frisk-master/code/Cleaning_Data.R')
dim(SQFdata)
```


## An치lisis descriptivo

```{r, message=FALSE}
drq.num <- paste("./dqr_num.csv", sep = "")
drq.cat <- paste("./dqr_cat.csv", sep = "")
checkDataQuality(SQFdata, out.file.num = drq.num,  out.file.cat = drq.cat)
DQR.num <- read.csv("dqr_num.csv")
DQR.cat <- read.csv("dqr_cat.csv")
```


## Transformaci칩n de los datos

### Eliminaci칩n de variables

```{r}
# Eliminaci蚤 de variables con m硬 de 60% de datos faltantes.
SQFdata_modif <- SQFdata %>%
                    select(-c(arstoffn, sumoffen, officrid, offverb, offshld,
                                       forceuse, othfeatr, addrnum, stname, beat, post))



# Eliminaci蚤 de variables con 20% de NAs pero nula varianza (casos pertenecientes
# todos a una misma clase). 6 variables eliminadas
SQFdata_modif <- SQFdata_modif %>%
                    select(-c(adtlrept, riflshot, asltweap, machgun,
                             pf_baton, pf_pepsp))



# Eliminaci蚤 de variables con demasiados niveles (strings). 4 variables eliminadas
SQFdata_modif <- SQFdata_modif %>%
                    select(-c(premname, stinter, crossst, sector))



# Eliminaci蚤 de variables que no aparecen en el checkDataQuality. 7 variables eliminadas.
SQFdata_modif <- SQFdata_modif %>%
                    select(-c(state,zip,addrtyp,rescode,premtype,aptnum,timestop))



# Eliminaci蚤 de factores con m硬 de 53 niveles. 4 variables eliminadas.
length(levels(SQFdata_modif$pct));length(levels(SQFdata_modif$crimsusp));
length(levels(SQFdata_modif$addrpct));length(levels(SQFdata_modif$detailCM))

SQFdata_modif <- SQFdata_modif %>%
                    select(-c(pct,crimsusp,addrpct,detailCM))



# Eliminaci蚤 de variables con poca varianza. 6 variables eliminadas.
SQFdata_modif <- SQFdata_modif %>%
                    select(-c(year,datestop,compyear,comppct, lineCM, dob))



# Eliminaci蚤 de m硬 variables con poca varianza. 1 variable eliminada.

# Se analiza el atributo y en caso de que no sea un factor, se devuelve valor
# 2 para que no sea eliminado.
fun_2level <- function(x){
    ifelse(is.factor(x),return(length(levels(x))),return(2))
}

names(SQFdata_modif)[which(sapply(SQFdata_modif, fun_2level) < 2)]

SQFdata_modif <- SQFdata_modif %>%
                    select(-c(which(sapply(SQFdata_modif, fun_2level) < 2)))

# Eliminaci蚤 de coordenadas:
SQFdata_modif <- SQFdata_modif %>%
                    select(-c(xcoord, ycoord))

```

### Eliminaci칩n de NAs

```{r}
# Eliminaci蚤 de NAs en variable age
SQFdata_modif %>% group_by(is.na(age)) %>%
    summarise(n())

SQFdata_modif <- SQFdata_modif %>% filter(!is.na(age))

SQFdata_modif$pistol[which(is.na(SQFdata_modif$pistol))]     <- 'N'
SQFdata_modif$knifcuti[which(is.na(SQFdata_modif$knifcuti))] <- 'N'
SQFdata_modif$othrweap[which(is.na(SQFdata_modif$othrweap))] <- 'N'

# USO DE FUERZA F펩ICA
SQFdata_modif$pf_hands[which(is.na(SQFdata_modif$pf_hands))] <- 'N'
SQFdata_modif$pf_wall[which(is.na(SQFdata_modif$pf_wall))]   <- 'N'
SQFdata_modif$pf_grnd[which(is.na(SQFdata_modif$pf_grnd))]   <- 'N'
SQFdata_modif$pf_drwep[which(is.na(SQFdata_modif$pf_drwep))] <- 'N'
SQFdata_modif$pf_ptwep[which(is.na(SQFdata_modif$pf_ptwep))] <- 'N'
SQFdata_modif$pf_hcuff[which(is.na(SQFdata_modif$pf_hcuff))] <- 'N'
SQFdata_modif$pf_other[which(is.na(SQFdata_modif$pf_other))] <- 'N'

# CIRCUNSTANCIAS ADICIONALES
SQFdata_modif$ac_rept[which(is.na(SQFdata_modif$ac_rept))]   <- 'N'
SQFdata_modif$ac_inves[which(is.na(SQFdata_modif$ac_inves))] <- 'N'
SQFdata_modif$ac_proxm[which(is.na(SQFdata_modif$ac_proxm))] <- 'N'
SQFdata_modif$ac_incid[which(is.na(SQFdata_modif$ac_incid))] <- 'N'
SQFdata_modif$ac_time[which(is.na(SQFdata_modif$ac_time))]   <- 'N'
SQFdata_modif$ac_evasv[which(is.na(SQFdata_modif$ac_evasv))] <- 'N'
SQFdata_modif$ac_assoc[which(is.na(SQFdata_modif$ac_assoc))] <- 'N'
SQFdata_modif$ac_cgdir[which(is.na(SQFdata_modif$ac_cgdir))] <- 'N'
SQFdata_modif$ac_stsnd[which(is.na(SQFdata_modif$ac_stsnd))] <- 'N'
SQFdata_modif$ac_other[which(is.na(SQFdata_modif$ac_other))] <- 'N'

SQFdata_modif %>% filter(is.na(cs_objcs)) %>%
    summarise(count_rf_vcrim  = sum(rf_vcrim == "Y", na.rm = TRUE),
            count_rf_othsw  = sum(rf_othsw == "Y", na.rm = TRUE),
            count_rf_attir  = sum(rf_attir == "Y", na.rm = TRUE),
            count_rf_vcact  = sum(rf_vcact == "Y", na.rm = TRUE),
            count_rf_rfcmp  = sum(rf_rfcmp == "Y", na.rm = TRUE),
            count_rf_furt  = sum(rf_furt == "Y", na.rm = TRUE),
            count_rf_bulg  = sum(rf_bulg == "Y", na.rm = TRUE),
            count_rf_verbl  = sum(rf_verbl == "Y", na.rm = TRUE),
            count_rf_knowl = sum(rf_knowl == "Y", na.rm = TRUE),
            tot = n()) %>%
    mutate(percent_rf_vcrim = 100*count_rf_vcrim/tot,
           percent_rf_othsw = 100*count_rf_othsw/tot,
           percent_rf_attir = 100*count_rf_attir/tot,
           percent_rf_vcact = 100*count_rf_vcact/tot,
           percent_rf_rfcmp = 100*count_rf_rfcmp/tot,
           percent_rf_furt = 100*count_rf_furt/tot,
           percent_rf_bulg = 100*count_rf_bulg/tot,
           percent_rf_verbl = 100*count_rf_verbl/tot,
           percent_rf_knowl = 100*count_rf_knowl/tot)

SQFdata_modif$rf_vcrim[which(is.na(SQFdata_modif$rf_vcrim))] <- 'N'
SQFdata_modif$rf_othsw[which(is.na(SQFdata_modif$rf_othsw))] <- 'N'
SQFdata_modif$rf_attir[which(is.na(SQFdata_modif$rf_attir))] <- 'N'
SQFdata_modif$rf_vcact[which(is.na(SQFdata_modif$rf_vcact))] <- 'N'
SQFdata_modif$rf_rfcmp[which(is.na(SQFdata_modif$rf_rfcmp))] <- 'N'
SQFdata_modif$rf_furt[which(is.na(SQFdata_modif$rf_furt))]   <- 'N'
SQFdata_modif$rf_bulg[which(is.na(SQFdata_modif$rf_bulg))]   <- 'N'
SQFdata_modif$rf_verbl[which(is.na(SQFdata_modif$rf_verbl))] <- 'N'
SQFdata_modif$rf_knowl[which(is.na(SQFdata_modif$rf_knowl))] <- 'N'

SQFdata_modif %>% filter(is.na(cs_objcs)) %>%
    summarise(count_cs_descr = sum(cs_descr == "Y", na.rm = TRUE),
              count_cs_casng = sum(cs_casng == "Y", na.rm = TRUE),
              count_cs_lkout = sum(cs_lkout == "Y", na.rm = TRUE),
              count_cs_cloth = sum(cs_cloth == "Y", na.rm = TRUE),
              count_cs_drgtr = sum(cs_drgtr == "Y", na.rm = TRUE),
              count_cs_furtv = sum(cs_furtv == "Y", na.rm = TRUE),
              count_cs_vcrim = sum(cs_vcrim == "Y", na.rm = TRUE),
              count_cs_bulge = sum(cs_bulge == "Y", na.rm = TRUE),
              count_cs_other = sum(cs_other == "Y", na.rm = TRUE),
              tot = n()) %>%
    mutate(percent_cs_descr = 100*count_cs_descr/tot,
           percent_cs_casng = 100*count_cs_casng/tot,
           percent_cs_lkout = 100*count_cs_lkout/tot,
           percent_cs_cloth = 100*count_cs_cloth/tot,
           percent_cs_drgtr = 100*count_cs_drgtr/tot,
           percent_cs_furtv = 100*count_cs_furtv/tot,
           percent_cs_vcrim = 100*count_cs_vcrim/tot,
           percent_cs_bulge = 100*count_cs_bulge/tot,
           percent_cs_other = 100*count_cs_other/tot)

SQFdata_modif$cs_objcs[which(is.na(SQFdata_modif$cs_objcs))] <- 'N'
SQFdata_modif$cs_descr[which(is.na(SQFdata_modif$cs_descr))] <- 'N'
SQFdata_modif$cs_casng[which(is.na(SQFdata_modif$cs_casng))] <- 'N'
SQFdata_modif$cs_lkout[which(is.na(SQFdata_modif$cs_lkout))] <- 'N'
SQFdata_modif$cs_cloth[which(is.na(SQFdata_modif$cs_cloth))] <- 'N'
SQFdata_modif$cs_drgtr[which(is.na(SQFdata_modif$cs_drgtr))] <- 'N'
SQFdata_modif$cs_furtv[which(is.na(SQFdata_modif$cs_furtv))] <- 'N'
SQFdata_modif$cs_vcrim[which(is.na(SQFdata_modif$cs_vcrim))] <- 'N'
SQFdata_modif$cs_bulge[which(is.na(SQFdata_modif$cs_bulge))] <- 'N'
SQFdata_modif$cs_other[which(is.na(SQFdata_modif$cs_other))] <- 'N'

SQFdata_modif %>% filter(is.na(sb_hdobj)) %>%
    summarise(count_outln = sum(sb_outln == "Y", na.rm = TRUE),
              count_admis = sum(sb_admis == "Y", na.rm = TRUE),
              count_other = sum(sb_other == "Y", na.rm = TRUE),
              tot = n()) %>%
    mutate(percent_outln = 100*count_outln/tot,
           percent_admis = 100*count_admis/tot,
           percent_other = 100*count_other/tot)

SQFdata_modif$sb_hdobj[which(is.na(SQFdata_modif$sb_hdobj))] <- 'N'
SQFdata_modif$sb_outln[which(is.na(SQFdata_modif$sb_outln))] <- 'N'
SQFdata_modif$sb_admis[which(is.na(SQFdata_modif$sb_admis))] <- 'N'
SQFdata_modif$sb_other[which(is.na(SQFdata_modif$sb_other))] <- 'N'

# Con nearZeroVar se eliminan m硬 variables
SQFdata_modif <- SQFdata_modif[-nearZeroVar(SQFdata_modif)]
dim(SQFdata)
dim(SQFdata_modif)
```

## Divisi칩n de muestra en train/test

```{r}
# Creaci칩n de conjuntos train y test
tot_obs <- dim(SQFdata_modif)[1]
indices <- 1:tot_obs

set.seed(1234)
indices_train <- sample(indices, 0.7*tot_obs)
SQFdataTrain = SQFdata_modif[indices_train, ]
SQFdataTest = SQFdata_modif[-indices_train, ]

# Datos desbalanceados
SQFdataTrain %>% group_by(arstmade) %>%
    summarise(count = n()) %>%
    mutate(percent = 100*count/sum(count))
```

### Ajuste del desbalanceo: Down-sampling y SMOTE

- Down-Sampling:

```{r}
# Total de casos -> 4847 (si) + 27203 (no) = 32050
# Queremos que los SI correspondan a un 50% de la muestra -> Los NO deber칤an ser 4847 casos
training.yes <- SQFdataTrain %>% filter(arstmade == 'Y')
training.no <- SQFdataTrain %>% filter(arstmade == 'N')

set.seed(4567)
ind_training.no <- sample(rownames(training.no),4799)
training.no <- training.no[ind_training.no,]

SQFdataTrain_DSAMP <- rbind(training.yes, training.no)

SQFdataTrain_DSAMP %>% group_by(arstmade) %>%
    summarise(count = n()) %>%
    mutate(percent = 100*count/sum(count))
```

- SMOTE:

En SMOTE perc.over determina el n칰mero de casos por caso que se a침aden a la clase minoritaria, mientras que perc.under es el n칰mero de casos que se seleccionan de la clase mayoritaria por caso a침adido a la minoritaria.

Es decir, en el caso que nos ocupa, la clase negativa son 4799 casos y la positiva 27103 Nos interesa que ambas clases posean el mismo n칰mero de casos, por lo que la clase negativa tendr치 que ser ampliada en 27103/4799 = 5.647 = 4.647 casos por cada caso que existe.

Para a침adir los casos necesarios, perc.over tiene que fijarse a un m칰ltiplo de 100, de lo contrario redondea a la baja. Para afinar el resultado, se ajusta perc.under de la siguiente forma:

Sabemos que para este caso debemos a침adir al menos 4.647 casos por caso en la clase minoritaria, perc.over se fija a 400 y se calcula el n칰mero de casos que se han de seleccionar de la clase mayoritaria en base al n칰mero de casos a침adidos. Se a침aden 4췅4799 = 19196 casos, por lo que en la clase minoritaria quedar치n finalmente $19196+4799=23995$ casos. Queremos que la clase mayoritaria alcance ese mismo n칰mero de casos, por lo que habr치 que seleccionar *X* casos por cada caso a침adido a la clase minoritaria: $19196췅X=23995$
Quedando como resultado final un perc.under de *1.25*.

```{r}
# Ajuste del desbalanceo con SMOTE (se rechaza la posibilidad de realizar
# up-sampling dado que es necesario a침adir demasiados casos)
set.seed(6789)
# SQFdataTrain_SMOTE <- SMOTE(arstmade ~ ., data=SQFdataTrain, k = 10, perc.over = 400, perc.under = 125)
# SQFdataTrain_SMOTE <- SMOTE(arstmade ~ ., data=SQFdataTrain, k = 10, perc.over = 300, perc.under = 133.33)
SQFdataTrain_SMOTE <- SMOTE(arstmade ~ ., data=SQFdataTrain, k = 10, perc.over = 100, perc.under = 200)
# SQFdataTrain_SMOTE <- SMOTE(arstmade ~ ., data=SQFdataTrain, k = 15, perc.over = 50, perc.under = 300)
# SQFdataTrain_SMOTE <- SMOTE(arstmade ~ ., data=SQFdataTrain, k = 15, perc.over = 20, perc.under = 600.4)
# SQFdataTrain_SMOTE <- SMOTE(arstmade ~ ., data=SQFdataTrain, k = 15, perc.over = 15, perc.under = 767.45)

SQFdataTrain_SMOTE %>% group_by(arstmade) %>%
    summarise(count = n()) %>%
    mutate(percent = 100*count/sum(count))
```



## KNN: arstmade

```{r}
# SEPARACION DE DATOS EN VARIABLES CUALITATIVAS Y CUANTITATIVAS
#==========================================================================================
# TRAIN
SQFdataTrain.numeric <- SQFdataTrain[,which(sapply(SQFdataTrain,is.numeric))]
SQFdataTrain.numeric$arstmade <- as.factor(as.numeric(SQFdataTrain$arstmade)-1)

SQFdataTrain_DSAMP.numeric <- SQFdataTrain_DSAMP[,which(sapply(SQFdataTrain_DSAMP,is.numeric))]
SQFdataTrain_DSAMP.numeric$arstmade <- as.factor(as.numeric(SQFdataTrain_DSAMP$arstmade)-1)

SQFdataTrain_SMOTE.numeric <- SQFdataTrain_SMOTE[,which(sapply(SQFdataTrain_SMOTE,is.numeric))]
SQFdataTrain_SMOTE.numeric$arstmade <- as.factor(as.numeric(SQFdataTrain_SMOTE$arstmade)-1)

SQFdataTrain.cat <- SQFdataTrain[,which(sapply(SQFdataTrain,is.factor))]
SQFdataTrain_DSAMP.cat <- SQFdataTrain_DSAMP[,which(sapply(SQFdataTrain_DSAMP,is.factor))]
SQFdataTrain_SMOTE.cat <- SQFdataTrain_SMOTE[,which(sapply(SQFdataTrain_SMOTE,is.factor))]


# TEST
SQFdataTest.numeric <- SQFdataTest[,which(sapply(SQFdataTest,is.numeric))]
SQFdataTest.numeric$arstmade <- as.factor(as.numeric(SQFdataTest$arstmade)-1)

SQFdataTest.cat <- SQFdataTest[,which(sapply(SQFdataTest,is.factor))]
```
## knn con variables numericas 
```{r}
train = SQFdataTrain
test =SQFdataTest
train.labels = SQFdataTrain$arstmade
test.labels = SQFdataTest$arstmade

train.numeric = train %>% select(ser_num,perobs,perstop,repcmd,revcmd,age,ht_feet,ht_inch,weight) %>% mutate_each(funs(scale))
test.numeric = test %>% select(ser_num,perobs,perstop,repcmd,revcmd,age,ht_feet,ht_inch,weight) %>% mutate_each(funs(scale))
knn_total <- knn1(train.numeric, test.numeric, train.labels)
error = sum(knn_total != test.labels)/length(test.labels);error
```

```{r}
train_DSAMP = SQFdataTrain_DSAMP
test_DSAMP =SQFdataTest
train_DSAMP.labels = SQFdataTrain_DSAMP$arstmade
test_DSAMP.labels = SQFdataTest$arstmade

train_DSAMP.numeric = train_DSAMP %>% select(ser_num,perobs,perstop,repcmd,revcmd,age,ht_feet,ht_inch,weight) %>% mutate_each(funs(scale))
test_DSAMP.numeric = test_DSAMP %>% select(ser_num,perobs,perstop,repcmd,revcmd,age,ht_feet,ht_inch,weight) %>% mutate_each(funs(scale))
knn_DSAMP <- knn1(train_DSAMP.numeric, test_DSAMP.numeric, train_DSAMP.labels)
error_DSAMP = sum(knn_DSAMP != test_DSAMP.labels)/length(test_DSAMP.labels);error_DSAMP
```

```{r}
train_SMOTE = SQFdataTrain_SMOTE
test_SMOTE =SQFdataTest
train_SMOTE.labels = SQFdataTrain_SMOTE$arstmade
test_SMOTE.labels = SQFdataTest$arstmade

train_SMOTE.numeric = train_SMOTE %>% select(ser_num,perobs,perstop,repcmd,revcmd,ht_feet,ht_inch,weight) %>% mutate_each(funs(scale))
test_SMOTE.numeric = test_SMOTE %>% select(ser_num,perobs,perstop,repcmd,revcmd,ht_feet,ht_inch,weight) %>% mutate_each(funs(scale))
knn_SMOTE <- knn1(train_SMOTE.numeric, test_SMOTE.numeric, train_SMOTE.labels)
error_SMOTE = sum(knn_SMOTE != test_SMOTE.labels)/length(test_SMOTE.labels);error_SMOTE
```

## KNN con variables categoricas
```{r}
#=============================================== KNN categorical DSAMP FALLA POR TAMA헲, quitar variables menos significativas
train_DSAMP.cat = SQFdataTrain_DSAMP %>%
  select(recstat,inout,trhsloc,typeofid,othpers,arstmade,offunif,frisked,searched,pf_hands,pf_hcuff,radio,ac_rept,ac_inves,rf_vcrim,rf_othsw,ac_proxm,rf_attir,cs_descr,cs_casng,cs_lkout,rf_vcact,cs_drgtr,ac_evasv,ac_assoc,cs_furtv,rf_rfcmp,ac_cgdir,cs_vcrim,cs_bulge,cs_other,ac_incid,ac_time,rf_knowl,ac_other,sb_hdobj,sb_other,rf_furt,rf_bulg,sex,race,build,city)%>%
mutate_each(funs(as.numeric)) 

test.cat = SQFdataTest %>% 
  select(recstat,inout,trhsloc,typeofid,othpers,arstmade,offunif,frisked,searched,pf_hands,pf_hcuff,radio,ac_rept,ac_inves,rf_vcrim,rf_othsw,ac_proxm,rf_attir,cs_descr,cs_casng,cs_lkout,rf_vcact,cs_drgtr,ac_evasv,ac_assoc,cs_furtv,rf_rfcmp,ac_cgdir,cs_vcrim,cs_bulge,cs_other,ac_incid,ac_time,rf_knowl,ac_other,sb_hdobj,sb_other,rf_furt,rf_bulg,sex,race,build,city)%>%
mutate_each(funs(as.numeric))

z = rep(1, dim(train_DSAMP.cat)[1]) %*% as.matrix(test.cat[1, ])
sim = apply(z - train_DSAMP.cat == 0, 1, sum)/dim(train_DSAMP.cat)[2]
# Repetimos para todos los puntos
ntrain = dim(train_DSAMP.cat)[1];ntrain
ntest = dim(test.cat)[1];ntest
d = dim(train_DSAMP.cat)[2]
sim = matrix(0, ntest, ntrain)
for (i in 1:ntest) {
  z = rep(1, ntrain) %*% as.matrix(test.cat[i, ])
  sim[i, ] = apply(z - train_DSAMP.cat == 0, 1, sum)/d
}
similaridadCategirica_DSAMP = sim
indices = apply(sim, 1, which.max)


prediccion = rep(0, ntest)
for (i in 1:ntest) {
  z = table(train_DSAMP.labels[which(sim[i, ] == sim[i, indices[i]])])
  prediccion[i] = attributes(which(z == max(z)))$names
}
z = table(train.labels[which(sim == max(sim))])
attributes(which(z == max(z)))$names
error2 = sum(prediccion != test.labels)/length(test.labels)
error2

total = rbind(test.cat, train_DSAMP.cat)
distanciaEuclidea = as.matrix(dist(total))[1:ntest, (ntest + 1):(ntest + ntrain)]
similaridadNumerica = 1 - distanciaEuclidea/max(distanciaEuclidea)
similaridadFinal_DSAMP = (0.3 * similaridadNumerica + 0.7 * similaridadCategorica)
sim = similaridadFinal_DSAMP
```

```{r}
#=============================================== KNN categorical completo
train.cat = SQFdataTrain %>%
  select(recstat,inout,trhsloc,typeofid,othpers,arstmade,offunif,frisked,searched,pf_hands,pf_hcuff,radio,ac_rept,ac_inves,rf_vcrim,rf_othsw,ac_proxm,rf_attir,cs_descr,cs_casng,cs_lkout,rf_vcact,cs_drgtr,ac_evasv,ac_assoc,cs_furtv,rf_rfcmp,ac_cgdir,cs_vcrim,cs_bulge,cs_other,ac_incid,ac_time,rf_knowl,ac_other,sb_hdobj,sb_other,rf_furt,rf_bulg,sex,race,build,city)%>%
mutate_each(funs(as.numeric)) 

test.cat = SQFdataTest %>% 
  select(recstat,inout,trhsloc,typeofid,othpers,arstmade,offunif,frisked,searched,pf_hands,pf_hcuff,radio,ac_rept,ac_inves,rf_vcrim,rf_othsw,ac_proxm,rf_attir,cs_descr,cs_casng,cs_lkout,rf_vcact,cs_drgtr,ac_evasv,ac_assoc,cs_furtv,rf_rfcmp,ac_cgdir,cs_vcrim,cs_bulge,cs_other,ac_incid,ac_time,rf_knowl,ac_other,sb_hdobj,sb_other,rf_furt,rf_bulg,sex,race,build,city)%>%
mutate_each(funs(as.numeric))

z = rep(1, dim(train.cat)[1]) %*% as.matrix(test.cat[1, ])
sim = apply(z - train.cat == 0, 1, sum)/dim(train.cat)[2]
# Repetimos para todos los puntos
ntrain = dim(train.cat)[1];ntrain
ntest = dim(test.cat)[1];ntest
d = dim(train.cat)[2]
sim = matrix(0, ntest, ntrain)
for (i in 1:ntest) {
  z = rep(1, ntrain) %*% as.matrix(test.cat[i, ])
  sim[i, ] = apply(z - train.cat == 0, 1, sum)/d
}
similaridadCategirica = sim
indices = apply(sim, 1, which.max)


prediccion = rep(0, ntest)
for (i in 1:ntest) {
  z = table(train.labels[which(sim[i, ] == sim[i, indices[i]])])
  prediccion[i] = attributes(which(z == max(z)))$names
}
z = table(train.labels[which(sim == max(sim))])
attributes(which(z == max(z)))$names
error2 = sum(prediccion != test.labels)/length(test.labels)
error2

total = rbind(test.cat, train.cat)
distanciaEuclidea = as.matrix(dist(total))[1:ntest, (ntest + 1):(ntest + ntrain)]
similaridadNumerica = 1 - distanciaEuclidea/max(distanciaEuclidea)
similaridadFinal = (0.3 * similaridadNumerica + 0.7 * similaridadCategorica)
sim = similaridadFinal
```


